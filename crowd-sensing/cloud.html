<!DOCTYPE html>
<html>
<head>
  <title>Cloud based Human Activity Recognition</title>  
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="author" content="Francesco Colasante">
  <meta name="description" content="Iot Assignment crowd sensing"> 
  <meta charset="UTF-8">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">

</head>
<body>

  <h2>Your local IP address is: </h2>
  <h2 id="ip"> ip address</h2>
  <script type="application/javascript">
  function getIP(json) {
    let ip = document.getElementById("ip");
    ip.innerHTML = json.ip;
  }
  </script>

  <script type="application/javascript" src="https://api.ipify.org?format=jsonp&callback=getIP"></script>


  <h1>Linear Accelerometer raw data</h1>
  <div id="lad">No data</div>
  <div class="progress">
    <div id="x" class="progress-bar bg-success" role="progressbar" style="width: 0%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
     </div>
     <div class="progress">
      <div id="y" class="progress-bar bg-info" role="progressbar" style="width: 0%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
    </div>
    <div class="progress">
      <div id="z" class="progress-bar bg-warning" role="progressbar" style="width: 0%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
    </div>
  <h2 id="stat"> To see all the data sent in the last hour with their respctive status, go to the following <a href="https://demo.thingsboard.io:/dashboard/b61584a0-9466-11ea-9a66-358c6522b855?publicId=d2ff5950-6a96-11ea-8e0a-7d0ef2a682d3">dashboard</a> developed thanks to <a href="https://thingsboard.io">ThingsBoard</a></h2>
  Console Log:
  <div id="cnsl" class="alert alert-dark" role="alert">
    ...
</div>

  <script>
    let access_token = 'qD0VYMtFyBPNCDj2Kol4';
    let lad = document.getElementById('lad');
    let stat = document.getElementById('stat');
    let ip = document.getElementById('ip').innerHTML;
    let cnsl = document.getElementById('cnsl');
    function print(text, append=true){
        if(append)
            cnsl.innerHTML += text;
        else
            cnsl.innerHTML = text;
    }

    let x = document.getElementById('x');
    let y = document.getElementById('y');
    let z = document.getElementById('z');

    print("Console is ready");
    if ( 'LinearAccelerationSensor' in window ) {
      let win = 4;
      let data = [];
      let x_array = [];
      let y_array = [];
      let z_array = [];
      let i = 0;

      //initialize sensor with frequency 1Hz
      let las = new LinearAccelerationSensor({frequency: 1});
      las.addEventListener('reading', function(la) {
      	//print value on html page
        x.style.width = la.target.x*100 + "%";
        y.style.width = la.target.y*100 + "%";
        z.style.width = la.target.z*100 + "%";
        lad.innerHTML = 'x: ' + la.target.x + '<br> y: ' + la.target.y + '<br> z: ' + la.target.z;
        //print('x: ' + la.target.x + '<br> y: ' + la.target.y + '<br> z: ' + la.target.z);
        if(i<win){
        	//save values in array
            data[i] = {x: Math.abs(la.target.x), y: Math.abs(la.target.y), z: Math.abs(la.target.z)};
          i++;
          print("<");
        }else{
            print(">");
            let payload = {
                ip: ip,
                data: data
            };
            let msg = JSON.stringify(payload);

        	//create message to be sent to thingsboard
          //var msg = "{\"ip\":" + ip +",\n\"data\":[\n"
          //			+"{\"x\":"+x_array[0]+",\"y\":"+y_array[0]+",\"z\":"+z_array[0]+"},\n"
          //			+"{\"x\":"+x_array[1]+",\"y\":"+y_array[1]+",\"z\":"+z_array[1]+"},\n"
          //			+"{\"x\":"+x_array[2]+",\"y\":"+y_array[2]+",\"z\":"+z_array[2]+"},\n"
          //			+"{\"x\":"+x_array[3]+",\"y\":"+y_array[3]+",\"z\":"+z_array[3]+"}\n"
          //			+"]\n}";`
          console.log(msg);
            print(msg);
          //TODO: send the message
          const Http = new XMLHttpRequest();
          const url= `https://demo.thingsboard.io/api/v1/${access_token}/telemetry`;
          Http.open("POST",url);
          Http.send(msg);
          Http.onreadystatechange = (e) => {
                print(Http.responseText)
            }
          //restart the time window
          i=0;
          data[i]({x: Math.abs(la.target.x), y: Math.abs(la.target.y), z: Math.abs(la.target.z)});
        }
      });
      //start sensor
      las.start();
    }
    //error messgae
    else lad.innerHTML = 'Linear Accelerometer not supported';

  </script>

</body>
</html>